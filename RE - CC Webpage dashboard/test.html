<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit Card Spending Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1E424A 0%, #57B2B5 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-left h1 {
            margin: 0;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        body {
            padding-top: 80px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .filters {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-weight: bold;
            color: #1E424A;
        }

        select {
            padding: 8px 12px;
            border: 2px solid #57B2B5;
            border-radius: 5px;
            background: white;
            color: #1E424A;
            min-width: 150px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #3A878C 0%, #57B2B5 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .kpi-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .kpi-value .positive {
            color: #c8e6c9; /* Light green */
        }

        .kpi-value .negative {
            color: #ffcdd2; /* Light red */
        }

        .kpi-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .kpi-count {
            font-size: 0.8em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .kpi-details {
            font-size: 0.8em;
            margin-top: 10px;
            opacity: 0.8;
            height: 30px; /* Reserve space */
            overflow: hidden;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #1E424A;
            margin-bottom: 15px;
            text-align: center;
        }

        .canvas-container {
            position: relative;
            height: 300px;
        }

        .button {
            background: linear-gradient(135deg, #3A878C 0%, #57B2B5 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: transform 0.2s;
        }

        .button:hover {
            transform: translateY(-2px);
        }

        .status-message {
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .subcategory-comparison {
            max-height: 300px; /* Adjusted height */
            overflow-y: auto;
        }

        .subcat-table {
            width: 100%;
            border-collapse: collapse;
        }
        .subcat-table th, .subcat-table td {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .subcat-table th {
            font-weight: bold;
            color: #333;
        }
        .subcat-table td:nth-child(2), .subcat-table td:nth-child(3), .subcat-table td:nth-child(4) {
            text-align: right;
        }

        .change-positive {
            color: #28a745;
            font-weight: bold;
        }

        .change-negative {
            color: #dc3545;
            font-weight: bold;
        }
        
        .header-button {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .header-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 0;
            border-radius: 10px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #1E424A 0%, #57B2B5 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .upload-section {
            text-align: center;
        }

        .upload-section label {
            display: block;
            margin-bottom: 15px;
            font-weight: bold;
            color: #1E424A;
        }
        
        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed #57B2B5;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            margin-bottom: 15px;
        }

        .success-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 1002;
            font-size: 1.1em;
            font-weight: bold;
            animation: popupFade 3s forwards;
        }

        @keyframes popupFade {
            0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
            15% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            85% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
            100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
        }

        @media (max-width: 768px) {
            .charts-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .kpi-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left"><h1>Credit Card Spending Dashboard</h1></div>
        <div class="header-right">
            <button class="header-button" onclick="toggleSettings()">Settings</button>
            <button class="header-button" onclick="exportPDF()">Export PDF</button>
        </div>
    </div>

    <div class="container">
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <span class="close" onclick="toggleSettings()">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="upload-section">
                        <label>Upload 'CC data.csv' File:</label>
                        <input type="file" id="csvFile" accept=".csv" class="file-input">
                        <button class="button" onclick="processFile()">Upload File</button>
                        <div id="uploadStatus"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="bankFilter">Account</label>
                <select id="bankFilter"></select>
            </div>
            <div class="filter-group">
                <label for="monthFilter">Month</label>
                <select id="monthFilter"></select>
            </div>
            <div class="filter-group">
                <label for="yearFilter">Year</label>
                <select id="yearFilter"></select>
            </div>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-value" id="monthlyExpenditures">$0.00</div>
                <div class="kpi-label">Monthly Expenditures</div>
                <div class="kpi-count" id="monthlyDebitCount">0 transactions</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="monthlyCredits">$0.00</div>
                <div class="kpi-label">Monthly Payments and Other Credits</div>
            </div>
             <div class="kpi-card">
                <div class="kpi-value" id="yearlyDebits">$0.00</div>
                <div class="kpi-label">Expenditure for the year</div>
                <div class="kpi-count" id="yearlyDebitCount">0 transactions</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="yearlyCredits">$0.00</div>
                <div class="kpi-label">Payments and Other Credits for the year</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-value" id="largestTransaction">$0.00</div>
                <div class="kpi-label">Largest Transaction</div>
                <div class="kpi-details" id="largestTransactionDetails">No data</div>
            </div>
        </div>

        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-title">Monthly Spend Trend</div>
                <div class="canvas-container"><canvas id="monthlyTrendChart"></canvas></div>
            </div>
             <div class="chart-container">
                <div class="chart-title">Year over Year Comparison</div>
                <div class="canvas-container"><canvas id="yoyComparisonChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Top 5 Categories</div>
                <div class="canvas-container"><canvas id="top5CategoriesChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Expense by Category</div>
                <div class="canvas-container"><canvas id="expenseByCategoryChart"></canvas></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Expense by Subcategory</div>
                <div class="subcategory-comparison" id="subcategoryComparison"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Expense by Year</div>
                <div class="canvas-container"><canvas id="expenseByYearChart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        let transactionData = [];
        let charts = {};
        const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
        
        const ccMappingData = [
            { "Bank name": "Chase - 6350", "Year": "2023" },
            { "Bank name": "US Bank - 6752", "Year": "2024" },
            { "Bank name": "Checking", "Year": "2025" },
            { "Bank name": "Chase - 6350", "Year": "2026" },
            { "Bank name": "US Bank - 6752", "Year": "2023" },
            { "Bank name": "Checking", "Year": "2024" }
        ];

        document.addEventListener('DOMContentLoaded', () => {
             document.querySelectorAll('select').forEach(sel => sel.addEventListener('change', updateDashboard));
             populateFilters();
             resetDashboardView();
        });

        function toggleSettings() {
            document.getElementById('settingsModal').style.display = document.getElementById('settingsModal').style.display === 'block' ? 'none' : 'block';
        }

        window.onclick = function(event) {
            if (event.target == document.getElementById('settingsModal')) {
                document.getElementById('settingsModal').style.display = 'none';
            }
        }

        function showSuccessPopup(message) {
            const popup = document.createElement('div');
            popup.className = 'success-popup';
            popup.textContent = message;
            document.body.appendChild(popup);
            setTimeout(() => { document.body.removeChild(popup); }, 3000);
        }
        
        function processFile() {
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            if (!file) {
                showStatus('Please select a CSV file', 'error');
                return;
            }

            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                transformHeader: header => header.trim(),
                complete: function(results) {
                    transactionData = results.data.map(row => {
                        const amountStr = String(row.Amount || '0').replace(/,/g, '');
                        row.Amount = parseFloat(amountStr) || 0;
                        // Correcting potential data inconsistencies
                        if (row.Category) row.Category = row.Category.trim().replace('Mortgaga Expense', 'Mortgage Expense');
                        return row;
                    });
                    populateFilters();
                    resetDashboardView();
                    showSuccessPopup('File uploaded successfully!');
                    toggleSettings();
                },
                error: function(err, file) {
                    showStatus('Error processing file. Please check format.', 'error');
                }
            });
        }

        function showStatus(message, type) {
            document.getElementById('uploadStatus').className = `status-message ${type}`;
            document.getElementById('uploadStatus').textContent = message;
        }

        function populateFilters() {
            const bankFilter = document.getElementById('bankFilter');
            const banks = [...new Set(ccMappingData.map(row => row['Bank name']).filter(Boolean))];
            bankFilter.innerHTML = '<option value="" disabled selected hidden>Select Account</option>';
            banks.forEach(bank => bankFilter.appendChild(new Option(bank, bank)));
            
            const monthFilter = document.getElementById('monthFilter');
            monthFilter.innerHTML = '<option value="" disabled selected hidden>Select Month</option>';
            months.forEach(month => monthFilter.appendChild(new Option(month, month)));

            const yearFilter = document.getElementById('yearFilter');
            const years = [...new Set(ccMappingData.map(row => row.Year).filter(y => y && !isNaN(y)))].sort((a,b) => b-a);
            yearFilter.innerHTML = '<option value="" disabled selected hidden>Select Year</option>';
            years.forEach(year => yearFilter.appendChild(new Option(year, year)));
        }

        function getFilteredTransactions() {
            const bankName = document.getElementById('bankFilter').value;
            const month = document.getElementById('monthFilter').value;
            const year = document.getElementById('yearFilter').value;

            if (!transactionData.length || !bankName || !month || !year) return [];
            
            return transactionData.filter(t => {
                const tBank = (t['Bank Name'] || '').trim();
                const tMonth = (t.Month || '').trim();
                const tYear = (t.Year || '').toString().trim();

                const matchBank = tBank.toLowerCase() === bankName.toLowerCase();
                const matchMonth = tMonth.toLowerCase() === month.toLowerCase();
                const matchYear = tYear === year;
                
                return matchBank && matchMonth && matchYear;
            });
        }

        function formatCurrency(value) {
            return value.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
        }

        function resetDashboardView() {
            document.getElementById('monthlyExpenditures').textContent = '$0.00';
            document.getElementById('monthlyCredits').textContent = '$0.00';
            document.getElementById('yearlyDebits').textContent = '$0.00';
            document.getElementById('yearlyCredits').textContent = '$0.00';
            document.getElementById('largestTransaction').textContent = '$0.00';
            document.getElementById('largestTransactionDetails').textContent = 'Please select data to begin.';
            document.getElementById('monthlyDebitCount').textContent = '0 transactions';
            document.getElementById('yearlyDebitCount').textContent = '0 transactions';
            Object.values(charts).forEach(chart => { if(chart) chart.destroy(); });
            charts = {};
            document.getElementById('subcategoryComparison').innerHTML = '';
        }

        function updateDashboard() {
            const bankName = document.getElementById('bankFilter').value;
            const month = document.getElementById('monthFilter').value;
            const year = document.getElementById('yearFilter').value;

            if (!bankName || !month || !year) {
                resetDashboardView();
                return;
            }

            updateKPIs();
            updateAllCharts();
        }
        
        function updateKPIs() {
            const filtered = getFilteredTransactions();
            const bankName = document.getElementById('bankFilter').value;
            const year = document.getElementById('yearFilter').value;

            let monthlyExpenditures = 0, monthlyCredits = 0, largestDebitAmount = 0;
            let largestDebitTransaction = null;
            let monthlyDebitCount = 0;
            
            filtered.forEach(t => {
                const amount = Math.abs(t.Amount || 0);
                const normalBalance = (t['Normal Balance'] || '').trim().toLowerCase();
                if (normalBalance === 'debit') {
                    monthlyExpenditures += amount;
                    monthlyDebitCount++;
                    if (amount > largestDebitAmount) {
                        largestDebitAmount = amount;
                        largestDebitTransaction = t;
                    }
                } else if (normalBalance === 'credit') {
                    monthlyCredits += amount;
                }
            });

            let yearlyDebits = 0, yearlyCredits = 0, yearlyDebitCount = 0;
            if (bankName && year) {
                const yearlyFilteredDebits = transactionData.filter(t => 
                    (t['Bank Name']||'').trim().toLowerCase() === bankName.toLowerCase() && 
                    String(t.Year).trim() == year &&
                    (t['Normal Balance'] || '').trim().toLowerCase() === 'debit'
                );
                
                yearlyDebitCount = yearlyFilteredDebits.length;
                yearlyDebits = yearlyFilteredDebits.reduce((sum, t) => sum + Math.abs(t.Amount || 0), 0);

                yearlyCredits = transactionData
                    .filter(t => (t['Bank Name']||'').trim().toLowerCase() === bankName.toLowerCase() && String(t.Year).trim() == year && (t['Normal Balance'] || '').trim().toLowerCase() === 'credit')
                    .reduce((sum, t) => sum + Math.abs(t.Amount || 0), 0);
            }

            document.getElementById('monthlyExpenditures').textContent = formatCurrency(monthlyExpenditures);
            document.getElementById('monthlyDebitCount').textContent = `${monthlyDebitCount} transactions`;
            document.getElementById('monthlyCredits').textContent = formatCurrency(monthlyCredits);
            document.getElementById('yearlyDebits').textContent = formatCurrency(yearlyDebits);
            document.getElementById('yearlyDebitCount').textContent = `${yearlyDebitCount} transactions`;
            document.getElementById('yearlyCredits').textContent = formatCurrency(yearlyCredits);
            document.getElementById('largestTransaction').textContent = formatCurrency(largestDebitAmount);
            document.getElementById('largestTransactionDetails').textContent = largestDebitTransaction ? `${largestDebitTransaction.Description} | ${largestDebitTransaction.Category}` : 'No expenditure data';
        }
        
        function updateAllCharts() {
            [ updateMonthlyTrendChart, updateYearOverYearChart, updateTop5CategoriesChart, updateExpenseByCategoryChart, updateSubcategoryComparison, updateExpenseByYearChart ].forEach(func => func());
        }

        function createOrUpdateChart(chartId, type, data, options) {
            const ctx = document.getElementById(chartId).getContext('2d');
            if (charts[chartId]) charts[chartId].destroy();
            charts[chartId] = new Chart(ctx, { type, data, options });
        }
        
        function updateMonthlyTrendChart() {
            const bankName = document.getElementById('bankFilter').value;
            const year = document.getElementById('yearFilter').value;
            if (!bankName || !year) return;
            
            // **** UPDATED SECTION ****
            // This list now includes the new categories from your file.
            const mainCategories = [
                "Household", 
                "Kids Expense", 
                "Other Expenses", 
                "Personal Expense", 
                "Wife - Personal Expense",
                "Insurance Expense",
                "Mortgage Expense"
            ];
            // Added more colors for the new categories
            const colors = ['#1E424A', '#3A878C', '#57B2B5', '#5C7C9E', '#8BA3C7', '#A8BFD9', '#D2DCE8'];
            // **** END OF UPDATED SECTION ****

            const datasets = mainCategories.map((cat, i) => ({
                label: cat,
                data: months.map(month =>
                    transactionData
                        .filter(t => (t['Bank Name']||'').trim().toLowerCase() === bankName.toLowerCase() && String(t.Year).trim() == year && (t.Month||'').trim().toLowerCase() === month.toLowerCase() && (t.Category||'').trim() === cat && (t['Normal Balance'] || '').trim().toLowerCase() === 'debit')
                        .reduce((sum, t) => sum + t.Amount, 0)
                ),
                borderColor: colors[i % colors.length],
                tension: 0.1,
                fill: false
            }));

            createOrUpdateChart('monthlyTrendChart', 'line', { labels: months, datasets }, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } });
        }
        
        function updateYearOverYearChart() {
            const bankName = document.getElementById('bankFilter').value;
            const year = document.getElementById('yearFilter').value;
            if (!bankName || !year) return;

            const prevYear = String(parseInt(year) - 1);
            const getDataForYear = (targetYear) => months.map(month => 
                transactionData
                    .filter(t => (t['Bank Name']||'').trim().toLowerCase() === bankName.toLowerCase() && String(t.Year).trim() == targetYear && (t.Month||'').trim().toLowerCase() === month.toLowerCase() && (t['Normal Balance'] || '').trim().toLowerCase() === 'debit')
                    .reduce((sum, t) => sum + t.Amount, 0)
            );

            createOrUpdateChart('yoyComparisonChart', 'bar', { labels: months, datasets: [
                { label: `${year} Spending`, data: getDataForYear(year), backgroundColor: '#3A878C' },
                { label: `${prevYear} Spending`, data: getDataForYear(prevYear), backgroundColor: '#A8BFD9' }
            ]}, { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } });
        }

        function updateTop5CategoriesChart() {
            const filtered = getFilteredTransactions().filter(t => (t['Normal Balance'] || '').trim().toLowerCase() === 'debit' && t.Category && (t.Category||'').trim() !== '');
            const totals = filtered.reduce((acc, t) => {
                const category = (t.Category || '').trim();
                acc[category] = (acc[category] || 0) + t.Amount;
                return acc;
            }, {});

            const sorted = Object.entries(totals).sort(([,a], [,b]) => b-a).slice(0, 5);
            
            createOrUpdateChart('top5CategoriesChart', 'bar', {
                labels: sorted.map(([cat]) => cat),
                datasets: [{ label: 'Amount', data: sorted.map(([, amt]) => amt), backgroundColor: ['#1E424A', '#3A878C', '#57B2B5', '#5C7C9E', '#8BA3C7'] }]
            }, { responsive: true, maintainAspectRatio: false, indexAxis: 'y', plugins: { legend: { display: false } } });
        }

        function updateExpenseByCategoryChart() {
            const filtered = getFilteredTransactions().filter(t => (t['Normal Balance'] || '').trim().toLowerCase() === 'debit' && t.Category);
            const totals = filtered.reduce((acc, t) => {
                acc[t.Category] = (acc[t.Category] || 0) + t.Amount;
                return acc;
            }, {});

            const options = { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' },
                tooltip: { callbacks: { label: function(context) {
                    const total = context.chart.data.datasets[0].data.reduce((sum, val) => sum + val, 0);
                    const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                    return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                }}}}};
            createOrUpdateChart('expenseByCategoryChart', 'pie', {
                labels: Object.keys(totals),
                datasets: [{ data: Object.values(totals), backgroundColor: ['#1E424A', '#3A878C', '#57B2B5', '#5C7C9E', '#8BA3C7', '#A8BFD9', '#D2DCE8'] }]
            }, options);
        }

        function updateSubcategoryComparison() {
            const container = document.getElementById('subcategoryComparison');
            container.innerHTML = '';
            
            const bankName = document.getElementById('bankFilter').value, month = document.getElementById('monthFilter').value, year = document.getElementById('yearFilter').value;
            if (!bankName || !month || !year) return;
            
            const currentMonthIndex = months.indexOf(month);
            const prevMonthName = currentMonthIndex > 0 ? months[currentMonthIndex - 1] : months[11];
            const prevMonthYear = currentMonthIndex > 0 ? year : String(parseInt(year) - 1);

            const getTotals = (m, y) => transactionData
                .filter(t => (t['Bank Name']||'').trim().toLowerCase() === bankName.toLowerCase() && (t.Month||'').trim().toLowerCase() === m.toLowerCase() && String(t.Year).trim() == y && (t['Normal Balance'] || '').trim().toLowerCase() === 'debit')
                .reduce((acc, t) => {
                    const subCat = (t['Sub Category'] || 'Uncategorized').trim();
                    if(subCat) acc[subCat] = (acc[subCat] || 0) + t.Amount;
                    return acc;
                }, {});

            const currentTotals = getTotals(month, year);
            const prevTotals = getTotals(prevMonthName, prevMonthYear);
            const allSubCats = [...new Set([...Object.keys(currentTotals), ...Object.keys(prevTotals)])];
            
            let tableHTML = `<table class="subcat-table"><thead><tr><th>Sub Category</th><th>Current</th><th>Previous</th><th>Change %</th></tr></thead><tbody>`;
            allSubCats.sort().forEach(subCat => {
                const current = currentTotals[subCat] || 0, prev = prevTotals[subCat] || 0;
                let change = 0, changeHtml = '<span>-</span>';
                if (prev > 0) change = ((current - prev) / prev) * 100;
                else if (current > 0) change = 100;

                if (current > 0 || prev > 0) {
                    if (change !== 0) {
                        const symbol = change > 0 ? '▲' : '▼', colorClass = change > 0 ? 'change-positive' : 'change-negative';
                        changeHtml = `<span class="${colorClass}">${symbol} ${Math.abs(change).toFixed(1)}%</span>`;
                    }
                    tableHTML += `<tr><td>${subCat}</td><td>${formatCurrency(current)}</td><td>${formatCurrency(prev)}</td><td>${changeHtml}</td></tr>`;
                }
            });
            container.innerHTML = tableHTML + '</tbody></table>';
        }

        function updateExpenseByYearChart() {
            const bankName = document.getElementById('bankFilter').value;
            if(!bankName) return;

            const totals = transactionData
                .filter(t => (t['Bank Name']||'').trim().toLowerCase() === bankName.toLowerCase() && (t['Normal Balance'] || '').trim().toLowerCase() === 'debit')
                .reduce((acc, t) => {
                    const year = String(t.Year).trim();
                    acc[year] = (acc[year] || 0) + t.Amount;
                    return acc;
                }, {});

            const years = ["2023", "2024", "2025"];
            const dataValues = years.map(year => totals[year] || 0);

            createOrUpdateChart('expenseByYearChart', 'bar', {
                labels: years,
                datasets: [{ label: 'Total Spend', data: dataValues, backgroundColor: '#3A878C' }]
            }, { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } });
        }

        function exportPDF() {
            if (transactionData.length === 0) {
                alert("Please upload data before exporting.");
                return;
            }
            const { jsPDF } = window.jspdf;
            const dashboard = document.querySelector('.container');

            html2canvas(dashboard, { 
                scale: 3, // Renders at 3x the resolution
                useCORS: true 
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                let heightLeft = imgHeight;

                const pdf = new jsPDF('p', 'mm', 'a4');
                let position = 0;

                // Add the first page
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;

                // Add new pages if content is longer than one page
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save('dashboard-export.pdf');
            });
        }
    </script>
</body>
</html>